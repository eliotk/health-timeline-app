<!DOCTYPE HTML>
<html>
<head>
  <title>Timeline</title>
  <link href="./dist/vis.css" rel="stylesheet" type="text/css" />
  <link href="./dist/vanilla-notify.css" rel="stylesheet" type="text/css" />
  <style>
    body, html {
      font-family: arial, sans-serif;
      font-size: 11pt;
      height: 100%;
      margin: 0px;
      padding: 0px;
    }

    h3 {
      font-size: .9em;
    }

    textarea {
      height: 400px;
    }

    .buttons {
      margin: 20px 0;
    }

    .buttons input {
      padding: 10px;
    }

    #visualization {
      height: inherit;
    }

    #editor {
      padding: 10px;
      float: right;
      width: 300px;
      background-color: beige;
    }

    .data-text.events {
      height: 300px;
      width: 100%;
      font-family:Consolas,Monaco,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New;
    }

    .data-text.ccda {
      width: 100%;
      height: 200px;
    }

    .vis-item .vis-item-overflow {
      overflow: visible;
    }
  </style>

  <script src="./dist/vis.js"></script>
  <script src="./dist/js-yaml.js"></script>
  <script src="./dist/vanilla-notify.js"></script>
  <script src="./dist/bluebutton.js"></script>
</head>
<body>
<div id="editor">
  <div class="buttons">
  </div>

  <h3>Events</h3>
  <a href="#"">Load sample events</a>
  <textarea id="data" class="data-text events">
  [
    {"id": 1, "content": "item 1<br>start", "start": "2014-01-23", "group": "0"},
    {"id": 2, "content": "item 2", "start": "2014-01-18", "group": "0"},
    {"id": 3, "content": "item 3", "start": "2014-01-21", "group": "0"},
    {"id": 4, "content": "item 4", "start": "2014-01-19", "end": "2014-01-24", "group": "0"},
    {"id": 5, "content": "item 5", "start": "2014-01-28", "type": "point", "group": "0"},
    {"id": 6, "content": "item 6", "start": "2014-01-26", "group": "0"}
  ]
  </textarea>
  <input type="button" id="save" value="Save" title="Save data from the Timeline into the textarea" />
  <input type="button" class="button file-save" value="Save to File" disabled />
  <h3>Import CCDA</h3>
  <a href="#" id="load-sample-ccda">Load sample CCD-A</a>
  <textarea id="ccda" class="data-text ccda">

  </textarea>
  <input type="button" id="import-ccda" value="Import" />
</div>

<div id="visualization"></div>


<script>
  /* TODO
  */

  var eventData = document.getElementById('data');
  var groupData = document.getElementById('groups');
  var ccdaData = document.getElementById('ccda');

  var btnSave = document.getElementById('save');
  var btnCcdaImport = document.getElementById('import-ccda');


  // Create an empty DataSet.
  // This DataSet is used for two way data binding with the Timeline.
  var items = new vis.DataSet();

  // create a timeline
  var container = document.getElementById('visualization');
  var options = {
    // editable: true
  };
  var groups = new vis.DataSet();
  var timeline = new vis.Timeline(container, items, groups, options);

  function Groups(events) {
    this._events = events;
    this.visArray = this._generateVisArray();
	}

  /* derive group array for vis js from events */
  Groups.prototype._generateVisArray = function () {
    var events = this._events;
    var unique = {};
    var distinct = [];
    for( var i in events ) {
      if( typeof(unique[events[i].group_name]) == "undefined" && typeof events[i].group_name !== "undefined"){
        distinct.push({ id: parseInt(i), content:events[i].group_name });
      }
      unique[events[i].group_name] = 'Unclassified';
    }

    return distinct;
  }

  /* return a groupd id from group name */
  Groups.prototype.groupId = function (group_name) {
    for (var group of this.visArray) {
      if (group.content == group_name) {
        return group.id;
      }
    }
  }

  function loadData() {
    // get and deserialize the data
    var rawData = jsyaml.load(eventData.value);

    var groupProcessing = new Groups(rawData);

    // map data items and convert any ongoing event to proper end date
    var data = rawData.map(function(item) {
      if(typeof item.end !== 'undefined' && item.end == 'ongoing') {
        item.end = vis.moment();
      }

      item.group = groupProcessing.groupId(item.group_name);

      if(typeof item.end !== 'undefined' && item.start == item.end) {
        delete item.end;
      }

      if(typeof item.end == 'undefined') {
        item.type = 'point';
      }


      return item;
    });

    // groupArray = createGroupArray(data);

    items.clear();
    items.add(data);

    groups.update( groupProcessing.visArray );

    // adjust the timeline window such that we see the loaded data
    timeline.fit();
  }

  function saveData() {
    localStorage.setItem('events', eventData.value);
    loadData();
    vNotify.success({title:'Data saved'});
  }
  // ceate an array of groups from events object
  function createGroupArray(events) {
    var unique = {};
    var distinct = [];

    for( var i in events ) {
      if( typeof(unique[events[i].group_name]) == "undefined"){

        distinct.push({ id: parseInt(i), content:events[i].group_name });
      }
      unique[events[i].group_name] = 'Unclassified';
    }
    return JSON.stringify(distinct);
  }
  function loadSampleCcda() {
    var xhr = new XMLHttpRequest();
    xhr.open('get', './sample-ccda.xml', false);
    xhr.send();
    ccdaData.value = xhr.responseText;
  }
  function importCcda() {
    ccdaProcessor = new CcdaProcessor(ccdaData.value);;
    eventData.value = JSON.stringify(ccdaProcessor.events(), null, 2);
    vNotify.success({title:'CCDA imported'});
  }

  var CcdaProcessor = function(ccdaData) {
    this.ccdaData = ccdaData;
    this.bb = BlueButton(ccdaData);
  }

  CcdaProcessor.prototype.events = function() {
    var encounterEvents = this.bb.data.encounters.map(function(encounter) {
      encounter.start = encounter.date;
      encounter.group_name = 'Encounters';
      encounter.content = encounter.name;
      return encounter;
    });

    var immunizationEvents = this.bb.data.immunizations.map(function(immunization) {
      immunization.content = immunization.product.name;
      immunization.start = immunization.date;
      immunization.group_name = 'Immunizations';
      return immunization;
    });

    var medicationEvents = this.bb.data.medications.map(function(item) {
      item.content = item.text;
      item.start = item.date_range.start;
      item.end = item.date_range.end;
      item.group_name = 'Medications';
      return item;
    });

    var problemEvents = this.bb.data.problems.map(function(item) {
      item.content = item.name;
      item.start = item.date_range.start;
      item.end = item.date_range.end;
      item.group_name = 'Problems';
      return item;
    });

    var procedureEvents = this.bb.data.procedures.map(function(item) {
      item.content = item.name;
      item.start = item.date;
      item.group_name = 'procedures';
      return item;
    });

    return encounterEvents.concat(immunizationEvents).concat(medicationEvents).concat(problemEvents).concat(procedureEvents);
  }

  btnSave.onclick = saveData;
  btnCcdaImport.onclick = importCcda;

  document.querySelector("#load-sample-ccda").addEventListener("click", function(event){
    event.preventDefault();
    loadSampleCcda();
  });

  events = localStorage.getItem("events");
  if (events != null) {
    eventData.value = events;
  }
  loadData();
</script>
</body>
</html>
